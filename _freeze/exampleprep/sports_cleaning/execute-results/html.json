{
  "hash": "119e769b708e6b074e1a75e383fac338",
  "result": {
    "markdown": "This file cleans data downloaded from the Equity in Athletics Data Analysis initiative, managed by the U.S.\nDepartment of Education.\n\n<https://ope.ed.gov/athletics/#/>\n\nI downloaded all available equity data for Duke and UNC from 2003 through 2021.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n:::\n\n\nGeneral format information: everything is in separate files, but the format is the same (1 row per school per year).\n\nSome of these counts appear to be inaccurate--for example, neither the UNC nor the Duke 2021 women's basketball team is listed as having a head coach.\nA quick google search shows this is clearly incorrect.\nThere are no part time female head coaches listed at all, in any sport--I have a feeling this might be the source of the error (but have no way to prove it).\n\nTo avoid drawing conclusions that rest on this data issue, and also for simplicity, I am just going to use the total number of coaches, not split out by coach gender or full time/part time status or head/assistant status.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and transform the data on number of male and female coaches for mens and womens teams\ncommoncols <- c(\"Survey Year\", \"UNITID\", \"Institution Name\", \"OPE ID\", \"State CD\", \"Classification Name\", \"Classification Other\", \"Sanction Code\", \"Sanction Name\", \"Male Undergraduates\", \"Female Undergraduates\", \"Type of Varsity Sports Teams\")\n\n\n# Load and transform data on number of athletes\nathletes <- read_csv(\"raw/Athletics_Participation_All_Sports_and_Men's_Women's_and_Coed_Teams_2003_2004_2005_2006_2007_2008_2009_2010_2011_2012_2013_2014_2015_2016_2017_2018_2019_2020_2021.csv\", \n                          show_col_types = FALSE) |> \n  select(-contains(\"Coed\"),\n         -contains(\"Total\")) |> \n  pivot_longer(names_to = c(\"sport\", \"teamgender\"),\n               names_pattern = \"(.*) ([[:alpha:]]*en)'s .*\",\n               values_to = \"nplayers\",\n               cols = -any_of(commoncols)) |> \n  rename(\n    school = \"Institution Name\",\n    year = \"Survey Year\",\n    maleug = \"Male Undergraduates\",\n    femaleug = \"Female Undergraduates\",\n    division = \"Classification Name\") |> \n  filter(!is.na(nplayers)) |> \n  mutate(teamgender = tolower(teamgender),\n         school = ifelse(school == \"Duke University\", \"Duke\", \"UNC\")) |> \n  select(school, year, division, sport, teamgender, nplayers) |> \n  filter(sport != \"Unduplicated Count\")\n\nreshape_sports <- function(f){\n  tomerge <- read_csv(paste0(\"raw/\", f), show_col_types = FALSE) |> \n    # we can calculate totals--so drop them; they complicate merging\n    select(-contains(\"Total\")) |> \n    pivot_longer(names_to = c(\"sport\", \"coachgender\", \"coachlevel\", \"assignstatus\"),\n                 names_pattern = \"(.*) ([[:alpha:]]*ale) (.*) Coach (.T)\",\n                 values_to = \"ncoaches\",\n                 cols = -any_of(commoncols)\n    ) |> \n    rename(teamgender = \"Type of Varsity Sports Teams\",\n           school = \"Institution Name\",\n           year = \"Survey Year\",\n           maleug = \"Male Undergraduates\",\n           femaleug = \"Female Undergraduates\",\n           division = \"Classification Name\") |> \n    select(school, year, division, teamgender, sport, coachgender, coachlevel, assignstatus, ncoaches) |> \n    mutate(teamgender = ifelse(teamgender == \"Men's Team\", \"men\", \"women\"),\n           coachgender = ifelse(coachgender == \"Male\", \"men\", \"women\"),\n           coachlevel = ifelse(coachlevel == \"Assistant\", \"assistant\", \"head\"),\n           school = ifelse(school == \"Duke University\", \"Duke\", \"UNC\")) |> \n    pivot_wider(\n      names_from = c(assignstatus, coachlevel, coachgender), \n      values_from = ncoaches) \n  \n  # |>\n  #   select(where(~any(!is.na(.))))\n  \n  return(tomerge)\n}\n\nassistants <- tibble()\nheads <- tibble()\ncoachfiles <- list.files(\"raw/\")[grepl(\"Coaches_\", list.files(\"raw/\"))]\nfor(f in coachfiles){\n  tomerge <- reshape_sports(f)\n  \n  if(str_detect(f, \"Assistant\")){\n    if(nrow(assistants) == 0){\n      assistants <- tomerge\n    } else {\n      assistants <- full_join(assistants, tomerge)\n    }\n  } else if(str_detect(f, \"Head\")){\n    if(nrow(heads) == 0){\n      heads <- tomerge\n    } else {\n      heads <- full_join(heads, tomerge)\n    }\n  }\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(school, year, division, teamgender, sport,\nFT_assistant_men, PT_assistant_men, FT_assistant_women, PT_assistant_women)`\nJoining with `by = join_by(school, year, division, teamgender, sport,\nFT_head_men, PT_head_men, FT_head_women, PT_head_women)`\n```\n:::\n\n```{.r .cell-code}\nteams <- assistants |> \n  full_join(heads)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(school, year, division, teamgender, sport)`\n```\n:::\n\n```{.r .cell-code}\nteams <- teams |> \n  filter(any(\n    !is.na(PT_head_women),\n    !is.na(PT_head_men),\n    !is.na(PT_assistant_women),\n    !is.na(PT_assistant_men),\n    !is.na(FT_head_women),\n    !is.na(FT_head_men),\n    !is.na(FT_assistant_women),\n    !is.na(FT_assistant_men)\n  ))\n\nteams[is.na(teams)] <- 0\n\nteams <- teams |> \n  mutate(\n    ncoaches = \n      PT_head_men + FT_head_men + PT_head_women + FT_head_women + \n      PT_assistant_men + FT_assistant_men + PT_assistant_women + FT_assistant_women,\n    coaches_head = PT_head_men + FT_head_men + PT_head_women + FT_head_women,\n    coaches_assistant = PT_assistant_men + FT_assistant_men + PT_assistant_women + FT_assistant_women,\n    coaches_FT = FT_head_men + FT_head_women + FT_assistant_men + FT_assistant_women,\n    coaches_PT = PT_head_men + PT_head_women + PT_assistant_men + PT_assistant_women,\n    coaches_women = FT_head_women + PT_head_women + FT_assistant_women + PT_assistant_women,\n    coaches_men = FT_head_men + PT_head_men + FT_assistant_men + PT_assistant_men,\n  ) |> \n  filter(ncoaches > 0)\n\n\n# Merge coach data and athletes data\nnpeople <- full_join(teams, athletes) |> \n  mutate(player_coach_ratio = nplayers/ncoaches) |> \n  filter(!is.na(nplayers)) |> \n  select(-starts_with(\"coaches\")) |> \n  select(-starts_with(\"PT\"), -starts_with(\"FT\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(school, year, division, teamgender, sport)`\n```\n:::\n\n```{.r .cell-code}\n# npeople_indiv <- npeople |> \n#   uncount(ncoaches) |> \n#   mutate(coachgender = ifelse(coachgender == \"men\", \"man\", \"woman\"))\n\nsaveRDS(npeople, file = \"sports_teams.rds\")\n# saveRDS(npeople_indiv, file = \"sports_npeople_indiv.rds\")\nsaveRDS(npeople, file = \"../slides/data/sports_teams.rds\")\nsaveRDS(npeople, file = \"../project_example/sports_teams.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and transform the data on average salaries for coaches on mens and womens teams\n\ncoachsalaries <- tibble()\nsalaryfiles <- list.files(\"raw/\")[grepl(\"Salaries\", list.files(\"raw/\"))]\nfor(f in salaryfiles){\n  coachtype <- str_extract(f, \"^[[:alpha:]]*\")\n  tomerge <- read_csv(paste0(\"raw/\", f), show_col_types = FALSE) |> \n    select(-contains(\"Coed\"), -contains(\"Total\")) |> \n    pivot_longer(names_to = c(\"teamgender\", \"population\"),\n                 names_pattern = \"(.*)'s Team .* per (.*)\",\n                 values_to = \"avsalary\",\n                 cols = c(-any_of(commoncols), -contains(\"Number\"))) |> \n    mutate(population = ifelse(population == \"FTE\", paste0(coachtype, \" FTE\"), population))\n  \n  if(nrow(coachsalaries) == 0){\n    coachsalaries <- tomerge\n  } else {\n    coachsalaries <- full_join(coachsalaries, tomerge) \n  }\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(`Survey Year`, UNITID, `OPE ID`, `Institution Name`,\n`State CD`, `Classification Name`, `Classification Other`, `Sanction Code`,\n`Sanction Name`, `Male Undergraduates`, `Female Undergraduates`, `Men's Team\nNumber of FTEs Included in Average`, `Women's Team Number of FTEs Included in\nAverage`, teamgender, population, avsalary)`\n```\n:::\n\n```{.r .cell-code}\ncoachsalaries <- coachsalaries |> \n    rename(men_fte_n = \"Men's Team Number of FTEs Included in Average\",\n           women_fte_n = \"Women's Team Number of FTEs Included in Average\",\n           men_asstcoach_n = \"Men's Team Number of Assistant Coaches Included in Average\",\n           women_asstcoach_n = \"Women's Team Number of Assistant Coaches Included in Average\",\n           men_headcoach_n = \"Men's Team Number of Head Coaches Included in Average\",\n           women_headcoach_n = \"Women's Team Number of Head Coaches Included in Average\") |> \n    mutate(ncoaches = case_when(teamgender == \"Men\" & str_detect(population, \"FTE\") ~ men_fte_n,\n                                teamgender == \"Women\" & str_detect(population, \"FTE\") ~ women_fte_n,\n                                teamgender == \"Men\" & population == \"Assistant Coach\" ~ men_asstcoach_n,\n                                teamgender == \"Women\" & population == \"Assistant Coach\" ~ women_asstcoach_n,\n                                teamgender == \"Men\" & population == \"Head Coach\" ~ men_headcoach_n,\n                                teamgender == \"Women\" & population == \"Head Coach\" ~ women_headcoach_n,\n    )) |> \n  mutate(coachlevel = tolower(str_extract(population, \"^[[:alpha:]]*\")),\n         emptype = tolower(str_extract(population, \"[[:alpha:]]*$\"))) |> \n  rename(\n    school = \"Institution Name\",\n    year = \"Survey Year\",\n    maleug = \"Male Undergraduates\",\n    femaleug = \"Female Undergraduates\",\n    division = \"Classification Name\") |> \n  select(school, year, division, teamgender, coachlevel, emptype, avsalary, ncoaches) |> \n  mutate(teamgender = tolower(teamgender),\n         school = ifelse(school == \"Duke University\", \"Duke\", \"UNC\"))\n\nsaveRDS(coachsalaries, file = \"../slides/data/sports_coachsalaries.rds\")\nsaveRDS(coachsalaries, file = \"sports_coachsalaries.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and transform data on aid given to student athletes and recruiting expenses (whole athletic program)\naid <- tibble()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load and transform data on expenses and revenues (sport-specific)\nmoney <- tibble()\n```\n:::\n",
    "supporting": [
      "sports_cleaning_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}